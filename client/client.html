<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Sumo Arena</title>
<script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
<style>
  body { 
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
      background: #222; 
      color: white; 
      text-align: center; 
      margin: 0; 
      overflow: hidden; /* Prevent scrolling */
  }

  /* --- UI LAYOUT --- */
  #game-container {
      position: relative;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100vh;
  }

  #controls { 
      margin-bottom: 20px; 
      z-index: 10;
  }

  /* Canvas styling */
  #arena { 
      background: #eee; 
      border-radius: 50%; 
      cursor: crosshair; 
      box-shadow: 0 0 30px rgba(0,0,0,0.8);
      outline: none;
  }

  /* Buttons */
  button { 
      margin-top: 20px;
      padding: 15px 15px; 
      font-size: 20px; 
      font-weight: bold;
      cursor: pointer; 
      background: #4CAF50; 
      color: white; 
      border: none; 
      border-radius: 5px; 
      transition: background 0.2s, transform 0.1s;
      box-shadow: 0 4px 6px rgba(0,0,0,0.3);
  }
  button:hover { background: #45a049; transform: scale(1.05); }
  button:active { transform: scale(0.95); }
  button:disabled { background: #555; cursor: not-allowed; transform: none; }

  /* Status Text */
  #statusText { margin-top: 15px; font-size: 18px; color: #ccc; height: 24px; }

  /* --- GAME OVER MODAL (The Popup) --- */
  #gameOverModal {
      display: none; /* Hidden by default */
      position: absolute;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background-color: rgba(0, 0, 0, 0.85); /* Dark semi-transparent background */
      z-index: 1000;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      backdrop-filter: blur(5px);
  }

  .modal-content {
      background: #2a2a2a;
      padding: 50px;
      border-radius: 15px;
      border: 2px solid #555;
      text-align: center;
      box-shadow: 0 0 50px rgba(0,0,0,0.8);
      animation: popIn 0.3s ease-out;
  }

  @keyframes popIn {
      from { transform: scale(0.8); opacity: 0; }
      to { transform: scale(1); opacity: 1; }
  }

  .modal-title { color: #ff5555; font-size: 48px; margin: 0 0 10px 0; text-transform: uppercase; letter-spacing: 2px; }
  .modal-winner { color: #fff; font-size: 24px; margin: 0 0 40px 0; }
  
  #restartBtn { background: #2196F3; }
  #restartBtn:hover { background: #0b7dda; }

  /* Debug Box */
  #debug { 
      position: fixed; top: 10px; left: 10px; 
      background: rgba(0,0,0,0.8); color: lime; 
      padding: 10px; font-family: monospace; 
      border: 1px solid lime; pointer-events: none;
      display: none; /* Hidden unless needed */
  }
</style>
</head>
<body>

<div id="game-container">
    
    <!-- LOBBY UI -->
    <div id="controls">
        <h2 style="margin: 0 0 10px 0;">Sumo Arena</h2>
        <button id="readyBtn">I AM READY</button>
        <div id="statusText">Waiting for connection...</div>
    </div>

    <!-- GAME CANVAS -->
    <canvas id="arena" width="600" height="600" tabindex="0"></canvas>

    <!-- GAME OVER MODAL -->
    <div id="gameOverModal">
        <div class="modal-content">
            <h1 class="modal-title">GAME ENDED</h1>
            <h2 id="winnerText" class="modal-winner">Winner: Player 1</h2>
            <button id="restartBtn">RESTART</button>
        </div>
    </div>

</div>

<!-- Debug Visualizer -->
<div id="debug">Waiting for input...</div>

<script type="module">
    import setupInput from './input.js';

    // ==== 1. Setup & Connection ====
    const socket = io("http://localhost:3000");
    let playerId;
    let roomId;
    let isMyTurnToReady = true;

    // UI Elements
    const readyBtn = document.getElementById("readyBtn");
    const statusText = document.getElementById("statusText");
    const modal = document.getElementById("gameOverModal");
    const winnerText = document.getElementById("winnerText");
    const restartBtn = document.getElementById("restartBtn");
    const canvas = document.getElementById("arena");
    const ctx = canvas.getContext("2d");

    // Initialize Input Module
    setupInput(socket);

    // ==== 2. UI LOGIC (The Flow) ====

    // A. LOBBY: Click Ready
    readyBtn.onclick = () => {
        socket.emit("player-ready");
        readyBtn.disabled = true; // Disable button so we don't spam it
        readyBtn.innerText = "WAITING FOR OTHERS...";
        readyBtn.style.backgroundColor = "#555";
        statusText.innerText = "You are ready.";
        canvas.focus(); // Focus game for inputs
    };

    // B. GAME OVER: Show Modal
    socket.on("game-over", (data) => {
        // 1. Determine text
        if (data.winner) {
            if (data.winner === playerId) {
                winnerText.innerText = "ðŸ† YOU WON! ðŸ†";
                winnerText.style.color = "#4CAF50"; // Green
            } else {
                winnerText.innerText = `Winner: Player ${data.winner.slice(0,4)}`;
                winnerText.style.color = "white";
            }
        } else {
            winnerText.innerText = "Draw / Everyone died";
            winnerText.style.color = "#aaa";
        }

        // 2. Show Modal (Overlay)
        modal.style.display = "flex";
        
        // 3. Reset local lobby UI (in background)
        readyBtn.style.display = "none"; // Hide ready button while modal is open
    });

    // C. RESTART: Click Button -> Go to Lobby
    restartBtn.onclick = () => {
        // 1. Hide Modal
        modal.style.display = "none";

        // 2. Show Lobby UI again
        readyBtn.style.display = "inline-block";
        readyBtn.disabled = false; // Re-enable click
        readyBtn.innerText = "I AM READY"; // Reset text
        readyBtn.style.backgroundColor = "#4CAF50"; // Reset color

        statusText.innerText = "Press Ready to start next round";
    };


    // ==== 3. Network Events ====
    socket.emit("join-room");
    
    socket.on("joined-room", (data) => {
        playerId = data.playerId;
        roomId = data.roomId;
        console.log(`Joined room ${roomId}`);
        statusText.innerText = "Connected. Press Ready.";
    });

    // Countdown / Timer updates
    socket.on("countdown", num => {
        statusText.innerText = "Game starting in: " + num;
        // Auto-close modal if game starts forcefully (edge case)
        modal.style.display = "none"; 
        readyBtn.style.display = "inline-block";
    });

    socket.on("ready-timer", num => statusText.innerText = "Waiting for stragglers: " + num);
    
    socket.on("room-updated", data => {
        const readyCount = data.players.filter(p => p.ready).length;
        const total = data.players.length;
        // Only update text if we aren't counting down to start
        if (!statusText.innerText.includes("starting")) {
            statusText.innerText = `Lobby: ${readyCount}/${total} Ready`;
        }
    });

    // ==== 4. Rendering Logic ====
    const arenaRadius = 250; 
    let gameState = { players: [] };

    socket.on("state-update", data => {
        gameState = data;
        drawArena();
    });

    function drawArena() {
        ctx.clearRect(0,0,canvas.width,canvas.height);

        ctx.save();
        ctx.translate(canvas.width/2, canvas.height/2);

        // Draw Arena
        ctx.beginPath();
        ctx.arc(0, 0, arenaRadius, 0, Math.PI*2);
        ctx.fillStyle = "#ddd";
        ctx.fill();
        ctx.lineWidth = 5;
        ctx.strokeStyle = "#444";
        ctx.stroke();

        // Draw Players
        gameState.players.forEach(p => {
            ctx.beginPath();
            ctx.arc(p.x, p.y, 25, 0, Math.PI*2);
            
            // Color based on state
            if (!p.alive) ctx.fillStyle = "#555"; // Dead
            else if (p.isInvulnerable) ctx.fillStyle = "gold";
            else if (p.isSliding) ctx.fillStyle = "cyan"; // Visual slide
            else if (p.id === playerId) ctx.fillStyle = "blue"; // Self
            else ctx.fillStyle = "red"; // Enemy

            ctx.fill();
            ctx.stroke();

            // ID Text
            ctx.fillStyle = "white";
            ctx.font = "12px Arial";
            ctx.textAlign = "center";
            ctx.fillText(p.id.slice(0,2), p.x, p.y+4);
        });

        ctx.restore();
    }
</script>
</body>
</html>