<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Sumo Arena Test Client</title>
<script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
<style>
  body { font-family: Arial, sans-serif; }
  #controls { margin-bottom: 10px; }
  #arena { width: 600px; height: 600px; border: 1px solid #000; background: #eee; }
</style>
</head>
<body>

<h2>Sumo Arena Test</h2>
<div id="controls">
  <button id="readyBtn">Ready</button>
  <button id="pushBtn">Push</button>
  <button id="sprintBtn">Sprint</button>
  <button id="slideBtn">Slide</button>
  <button id="invulBtn">Invul</button>
</div>
<div id="countdown"></div>
<canvas id="arena" width="600" height="600"></canvas>

<script>
// ==== Socket.io connection ====
const socket = io("http://localhost:3000");
let playerId;
let roomId;

// ==== Network module integration ====
const network = {
    sendInput: (input) => socket.emit("input", input),
    ready: () => socket.emit("player-ready"),
    ability: (name) => socket.emit("ability", name)
};

// Player movement
const movement = { vx: 0, vy: 0 };

// ==== Join room automatically ====
socket.emit("join-room");
socket.on("joined-room", (data) => {
    playerId = data.playerId;
    roomId = data.roomId;
    console.log(`Joined room ${roomId} as ${playerId}`);
});

// Countdown display
socket.on("countdown", num => document.getElementById("countdown").innerText = "Game starting in: " + num);
socket.on("ready-timer", num => document.getElementById("countdown").innerText = "Ready timer: " + num);

// Show ready players
socket.on("room-updated", data => {
    const readyCount = data.players.filter(p => p.ready).length;
    document.getElementById("countdown").innerText = `Ready: ${readyCount}/${data.players.length}`;
});

// Buttons using network module + alerts for testing
document.getElementById("readyBtn").onclick = () => { network.ready(); };
document.getElementById("pushBtn").onclick = () => { network.ability("push");};
document.getElementById("sprintBtn").onclick = () => { network.ability("sprint"); };
document.getElementById("slideBtn").onclick = () => { network.ability("slide");};
document.getElementById("invulBtn").onclick = () => { network.ability("invul"); };

// Movement via arrows + WASD
document.addEventListener("keydown", e => {
    let changed = false;
    switch(e.key.toLowerCase()) {
        case "arrowup": case "w": movement.vy = -1; changed = true; break;
        case "arrowdown": case "s": movement.vy = 1; changed = true; break;
        case "arrowleft": case "a": movement.vx = -1; changed = true; break;
        case "arrowright": case "d": movement.vx = 1; changed = true; break;
    }
    if(changed) network.sendInput(movement);
});
document.addEventListener("keyup", e => {
    let changed = false;
    switch(e.key.toLowerCase()) {
        case "arrowup": case "w":
        case "arrowdown": case "s": movement.vy = 0; changed = true; break;
        case "arrowleft": case "a":
        case "arrowright": case "d": movement.vx = 0; changed = true; break;
    }
    if(changed) network.sendInput(movement);
});

// ==== Canvas setup ====
const canvas = document.getElementById("arena");
const ctx = canvas.getContext("2d");
const arenaRadius = 250; 
let gameState = { players: [] };

// Receive state updates
socket.on("state-update", data => {
    gameState = data;
    drawArena();
});

// Draw arena & players
function drawArena() {
    ctx.clearRect(0,0,canvas.width,canvas.height);

    // Arena circle
    ctx.beginPath();
    ctx.arc(canvas.width/2, canvas.height/2, arenaRadius, 0, Math.PI*2);
    ctx.fillStyle = "#ddd";
    ctx.fill();
    ctx.strokeStyle = "#000";
    ctx.stroke();

    // Players
    gameState.players.forEach(p => {
        const x = canvas.width/2 + p.x;
        const y = canvas.height/2 + p.y;

        ctx.beginPath();
        ctx.arc(x, y, 25, 0, Math.PI*2);
        ctx.fillStyle = p.alive ? "green" : "red";
        ctx.fill();
        ctx.strokeStyle = "#000";
        ctx.stroke();

        ctx.fillStyle = "white";
        ctx.font = "12px Arial";
        ctx.textAlign = "center";
        ctx.fillText(p.id.slice(0,2), x, y+4);
    });
}
</script>
</body>
</html>
