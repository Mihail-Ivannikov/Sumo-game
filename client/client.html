<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Sumo Arena</title>
<script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
<style>
  body { 
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
      background: #222; 
      color: white; 
      text-align: center; 
      margin: 0; 
      overflow: hidden; 
  }

  /* --- SCREENS --- */
  .screen {
      position: absolute;
      top: 0; left: 0;
      width: 100%; height: 100vh;
      display: none; 
      flex-direction: column;
      align-items: center;
      justify-content: center;
  }
  .active-screen { display: flex; }

  /* --- LOGIN SCREEN --- */
  #login-screen input {
      padding: 15px; font-size: 18px; border-radius: 5px; border: none; margin-bottom: 20px; text-align: center;
  }

  /* --- LOBBY SCREEN --- */
  #lobby-list {
      background: #333; padding: 20px; border-radius: 10px; width: 300px; margin-bottom: 20px; border: 2px solid #555;
  }
  .lobby-player {
      display: flex; justify-content: space-between; padding: 10px; border-bottom: 1px solid #444; font-size: 18px;
  }
  .status-ready { color: #4CAF50; font-weight: bold; }
  .status-waiting { color: #aaa; }

  /* --- GAME LAYOUT --- */
  #game-layout {
      display: flex;
      flex-direction: row; 
      align-items: center;
      justify-content: center;
      gap: 30px; 
  }

  #game-container { position: relative; }

  #arena { 
      background: #eee; 
      border-radius: 50%; 
      cursor: crosshair; 
      box-shadow: 0 0 30px rgba(0,0,0,0.8);
      outline: none;
  }

  /* --- ABILITY BAR --- */
  #ability-bar {
      display: flex;
      flex-direction: column;
      gap: 20px;
  }

  .ability-slot {
      width: 80px; height: 80px;
      background-color: #222; 
      border: 3px solid #555;
      border-radius: 10px;
      position: relative;
      overflow: hidden; 
      box-shadow: 0 4px 8px rgba(0,0,0,0.6);
      transition: all 0.2s;
  }

  /* Ready State: Bright Green Border & Glow */
  .ability-slot.ready {
      border-color: #00FF00;
      box-shadow: 0 0 15px rgba(0, 255, 0, 0.4);
      transform: scale(1.05);
  }

  .ability-icon {
      width: 100%; height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 32px;
  }
  
  /* Ability Colors */
  #slot-push .ability-icon { background: #E91E63; }   
  #slot-sprint .ability-icon { background: #FF9800; } 
  #slot-slide .ability-icon { background: #03A9F4; }  
  #slot-invul .ability-icon { background: #FFD700; color: black; } 

  /* COOLDOWN OVERLAY (The Dark Curtain) */
  .cooldown-overlay {
      position: absolute;
      bottom: 0; left: 0;
      width: 100%;
      height: 0%; /* 0% = Ready, 100% = Full Cooldown */
      background-color: rgba(0, 0, 0, 0.75); /* Dark transparent */
      z-index: 5;
  }

  /* Text Labels */
  .key-marker {
      position: absolute; top: 5px; left: 8px;
      font-weight: 900; color: white; font-size: 16px;
      z-index: 10; text-shadow: 2px 2px 0 #000;
  }
  .ability-name {
      position: absolute; bottom: 5px; width: 100%;
      text-align: center; font-size: 12px; font-weight: bold;
      color: white; z-index: 10; text-transform: uppercase;
      text-shadow: 2px 2px 0 #000;
  }

  /* --- UI COMPONENTS --- */
  h1, h2 { margin: 0 0 20px 0; text-transform: uppercase; letter-spacing: 2px; }

  button { 
      padding: 15px 30px; font-size: 20px; font-weight: bold; cursor: pointer; 
      background: #4CAF50; color: white; border: none; border-radius: 5px; margin: 5px;
      transition: transform 0.1s;
  }
  button:hover { background: #45a049; transform: scale(1.05); }
  button:active { transform: scale(0.95); }
  button:disabled { background: #555; cursor: not-allowed; transform: none; }
  
  #exitBtn { background: #f44336; }
  #exitBtn:hover { background: #d32f2f; }
  #restartBtn { background: #2196F3; }

  /* Modal */
  #gameOverModal {
      display: none; position: absolute; top: 0; left: 0; width: 100%; height: 100%;
      background-color: rgba(0,0,0,0.85); z-index: 1000;
      flex-direction: column; justify-content: center; align-items: center;
  }
  .modal-content { background: #2a2a2a; padding: 50px; border-radius: 15px; border: 2px solid #555; }
  .modal-title { color: #ff5555; font-size: 48px; }
  .modal-winner { color: #fff; font-size: 24px; margin-bottom: 40px; }

  #countdown-overlay {
      position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
      font-size: 100px; font-weight: bold; color: yellow; display: none; z-index: 100;
      pointer-events: none; text-shadow: 0 0 20px black;
  }
</style>
</head>
<body>

<!-- SCREEN 1: LOGIN -->
<div id="login-screen" class="screen active-screen">
    <h1>Sumo Arena</h1>
    <input type="text" id="usernameInput" placeholder="Enter Username" maxlength="10">
    <button id="joinBtn">JOIN GAME</button>
</div>

<!-- SCREEN 2: LOBBY -->
<div id="lobby-screen" class="screen">
    <h2>Waiting Room</h2>
    <div id="lobby-list"></div>
    <div id="lobbyStatus" style="margin-bottom: 20px; color: #ccc;">Waiting for players...</div>
    <div>
        <button id="readyBtn">I AM READY</button>
        <button id="exitBtn">EXIT</button>
    </div>
</div>

<!-- SCREEN 3: GAME -->
<div id="game-screen" class="screen">
    <div id="game-layout">
        <!-- ARENA -->
        <div id="game-container">
            <canvas id="arena" width="600" height="600" tabindex="0"></canvas>
            <div id="countdown-overlay">3</div>
        </div>

        <!-- ABILITY BAR -->
        <div id="ability-bar">
            <!-- Push -->
            <div id="slot-push" class="ability-slot ready">
                <div class="key-marker">Q</div>
                <div class="ability-icon">üëä</div>
                <div class="ability-name">PUSH</div>
                <div class="cooldown-overlay" id="cd-push"></div>
            </div>
            <!-- Sprint -->
            <div id="slot-sprint" class="ability-slot ready">
                <div class="key-marker">E</div>
                <div class="ability-icon">‚ö°</div>
                <div class="ability-name">SPRINT</div>
                <div class="cooldown-overlay" id="cd-sprint"></div>
            </div>
            <!-- Slide -->
            <div id="slot-slide" class="ability-slot ready">
                <div class="key-marker">SHIFT</div>
                <div class="ability-icon">üí®</div>
                <div class="ability-name">SLIDE</div>
                <div class="cooldown-overlay" id="cd-slide"></div>
            </div>
            <!-- Invul -->
            <div id="slot-invul" class="ability-slot ready">
                <div class="key-marker">R</div>
                <div class="ability-icon">üõ°Ô∏è</div>
                <div class="ability-name">INVUL</div>
                <div class="cooldown-overlay" id="cd-invul"></div>
            </div>
        </div>
    </div>
</div>

<!-- MODAL -->
<div id="gameOverModal">
    <div class="modal-content">
        <h1 class="modal-title">GAME ENDED</h1>
        <h2 id="winnerText" class="modal-winner">Winner: Player 1</h2>
        <button id="restartBtn">GO TO LOBBY</button>
    </div>
</div>

<script type="module">
    import setupInput from './input.js';

    // ==== 1. Setup ====
    const socket = io("http://localhost:3000");
    let playerId;
    
    // Images
    const imgPlayerIdle = new Image(); imgPlayerIdle.src = "./img/Player.png"; 
    const imgPlayerRun1 = new Image(); imgPlayerRun1.src = "./img/Player_run_1.png";
    const imgPlayerRun2 = new Image(); imgPlayerRun2.src = "./img/Player_run_2.png";
    const imgEnemyIdle = new Image();  imgEnemyIdle.src = "./img/Player_enemy.png"; 
    const imgEnemyRun1 = new Image();  imgEnemyRun1.src = "./img/Player_enemy_run_1.png";
    const imgEnemyRun2 = new Image();  imgEnemyRun2.src = "./img/Player_enemy_run_2.png";

    // Refs
    const loginScreen = document.getElementById("login-screen");
    const lobbyScreen = document.getElementById("lobby-screen");
    const gameScreen = document.getElementById("game-screen");
    const usernameInput = document.getElementById("usernameInput");
    const joinBtn = document.getElementById("joinBtn");
    const lobbyList = document.getElementById("lobby-list");
    const lobbyStatus = document.getElementById("lobbyStatus");
    const readyBtn = document.getElementById("readyBtn");
    const exitBtn = document.getElementById("exitBtn");
    const canvas = document.getElementById("arena");
    const ctx = canvas.getContext("2d");
    const countdownOverlay = document.getElementById("countdown-overlay");
    const modal = document.getElementById("gameOverModal");
    const winnerText = document.getElementById("winnerText");
    const restartBtn = document.getElementById("restartBtn");

    // Ability Refs
    const cdPush = document.getElementById("cd-push");
    const cdSprint = document.getElementById("cd-sprint");
    const cdSlide = document.getElementById("cd-slide");
    const cdInvul = document.getElementById("cd-invul");
    const slotPush = document.getElementById("slot-push");
    const slotSprint = document.getElementById("slot-sprint");
    const slotSlide = document.getElementById("slot-slide");
    const slotInvul = document.getElementById("slot-invul");

    const myInput = setupInput(socket);

    // COOLDOWNS (Must match server/player.js values)
    const MAX_CD = {
        push: 3000,
        sprint: 10000,
        slide: 3000,
        invul: 20000
    };

    // ==== 2. Navigation ====
    function showScreen(screenName) {
        loginScreen.classList.remove("active-screen");
        lobbyScreen.classList.remove("active-screen");
        gameScreen.classList.remove("active-screen");
        if(screenName === "login") loginScreen.classList.add("active-screen");
        if(screenName === "lobby") lobbyScreen.classList.add("active-screen");
        if(screenName === "game") gameScreen.classList.add("active-screen");
    }

    // ==== 3. UI Logic ====
    joinBtn.onclick = () => {
        const name = usernameInput.value.trim() || "Player";
        socket.emit("join-game", name); 
        showScreen("lobby");
    };

    readyBtn.onclick = () => {
        socket.emit("player-ready");
        readyBtn.disabled = true;
        readyBtn.innerText = "WAITING...";
        readyBtn.style.backgroundColor = "#555";
    };

    exitBtn.onclick = () => {
        socket.emit("leave-lobby");
        readyBtn.disabled = false;
        readyBtn.innerText = "I AM READY";
        readyBtn.style.backgroundColor = "#4CAF50";
        lobbyList.innerHTML = "";
        lobbyStatus.innerText = "Waiting...";
        showScreen("login");
    };

    restartBtn.onclick = () => {
        modal.style.display = "none";
        readyBtn.disabled = false;
        readyBtn.innerText = "I AM READY";
        readyBtn.style.backgroundColor = "#4CAF50";
        countdownOverlay.style.display = "none";
        showScreen("lobby");
    };

    // ==== 4. Socket Events ====
    socket.on("joined-room", (data) => { playerId = data.playerId; });

    socket.on("room-updated", (data) => { renderLobby(data.players); });

    function renderLobby(players) {
        lobbyList.innerHTML = "";
        let readyCount = 0;

        const me = players.find(p => p.id === playerId);
        if (me) {
            if (!me.ready) {
                readyBtn.disabled = false;
                readyBtn.innerText = "I AM READY";
                readyBtn.style.backgroundColor = "#4CAF50";
            } else {
                readyBtn.disabled = true;
                readyBtn.innerText = "WAITING...";
                readyBtn.style.backgroundColor = "#555";
            }
        }

        players.forEach(p => {
            if(p.ready) readyCount++;
            const div = document.createElement("div");
            div.className = "lobby-player";
            const nameSpan = document.createElement("span");
            nameSpan.innerText = p.username || "Unknown";
            if(p.id === playerId) nameSpan.style.color = "#4CAF50"; 
            const statusSpan = document.createElement("span");
            statusSpan.innerText = p.ready ? "READY" : "WAITING";
            statusSpan.className = p.ready ? "status-ready" : "status-waiting";
            div.appendChild(nameSpan); div.appendChild(statusSpan);
            lobbyList.appendChild(div);
        });
        lobbyStatus.innerText = `${readyCount} / ${players.length} Players Ready`;
    }

    socket.on("countdown", num => {
        if (num === null || num < 0) {
            countdownOverlay.style.display = "none";
            return;
        }
        if(!gameScreen.classList.contains("active-screen")) {
            showScreen("game");
            canvas.focus();
        }
        countdownOverlay.style.display = "block";
        countdownOverlay.innerText = num > 0 ? num : "FIGHT!";
        if (num <= 0) setTimeout(() => { countdownOverlay.style.display = "none"; }, 1000);
    });

    socket.on("game-over", (data) => {
        if (data.winner) {
            if (data.winner === playerId) {
                winnerText.innerText = "üèÜ YOU WON! üèÜ";
                winnerText.style.color = "#4CAF50";
            } else {
                winnerText.innerText = "You Lost!";
                winnerText.style.color = "white";
            }
        } else {
            winnerText.innerText = "Draw / Everyone died";
            winnerText.style.color = "#aaa";
        }
        modal.style.display = "flex";
    });

    // ==== 5. Ability Logic ====
    function updateAbilityUI(myPlayer) {
        const cds = myPlayer.abilitiesCooldowns;

        const updateSlot = (overlayEl, slotEl, current, max) => {
            // current = milliseconds remaining
            if (current <= 0) {
                // READY: Hide overlay completely
                overlayEl.style.height = "0%";
                slotEl.classList.add("ready");
            } else {
                // COOLDOWN: Overlay covers percentage of height
                const percent = (current / max) * 100;
                overlayEl.style.height = percent + "%";
                slotEl.classList.remove("ready");
            }
        };

        updateSlot(cdPush, slotPush, cds.push, MAX_CD.push);
        updateSlot(cdSprint, slotSprint, cds.sprint, MAX_CD.sprint);
        updateSlot(cdSlide, slotSlide, cds.slide, MAX_CD.slide);
        updateSlot(cdInvul, slotInvul, cds.invul, MAX_CD.invul);
    }

    // ==== 6. Rendering ====
    let animations = []; 
    socket.on("ability-used", (data) => {
        if (data.ability === "push") {
            animations.push({ playerId: data.playerId, type: "push", startTime: Date.now(), duration: 200 });
        }
    });

    const arenaRadius = 250; 
    let gameState = { players: [] };
    const playerAngles = {};

    socket.on("state-update", data => {
        gameState = data;
        
        if(gameScreen.classList.contains("active-screen")) {
            drawArena();
            // Update my UI
            const me = gameState.players.find(p => p.id === playerId);
            if (me) updateAbilityUI(me);
        }
    });

    function drawArena() {
        ctx.clearRect(0,0,canvas.width,canvas.height);
        ctx.save();
        ctx.translate(canvas.width/2, canvas.height/2);

        // Floor
        ctx.beginPath();
        ctx.arc(0, 0, arenaRadius, 0, Math.PI*2);
        ctx.fillStyle = "#ddd";
        ctx.fill();
        ctx.lineWidth = 5;
        ctx.strokeStyle = "#444";
        ctx.stroke();

        const now = Date.now();
        animations = animations.filter(anim => now - anim.startTime < anim.duration);

        gameState.players.forEach(p => {
            if(!p.alive && p.id !== playerId) return; 

            ctx.save();
            // Rotation
            if (Math.abs(p.vx) > 0.1 || Math.abs(p.vy) > 0.1) {
                playerAngles[p.id] = Math.atan2(p.vy, p.vx);
            }
            let angle = playerAngles[p.id];
            if (angle === undefined) angle = Math.PI / 2;

            ctx.translate(p.x, p.y);
            ctx.rotate(angle - Math.PI / 2);

            // Push Anim
            const activeAnim = animations.find(a => a.playerId === p.id && a.type === "push");
            if (activeAnim) {
                const progress = (now - activeAnim.startTime) / activeAnim.duration;
                const offset = Math.sin(progress * Math.PI) * 15;
                ctx.translate(0, offset); 
                
                ctx.beginPath();
                ctx.arc(0, 40, 20 + (progress * 30), 0, Math.PI, false);
                ctx.lineWidth = 5 - (progress * 5);
                ctx.strokeStyle = `rgba(255, 255, 255, ${1 - progress})`; 
                ctx.stroke();
            }

            // Status
            if (p.isInvulnerable) {
                ctx.beginPath(); ctx.arc(0, 0, 35, 0, Math.PI*2);
                ctx.fillStyle = "rgba(255, 215, 0, 0.5)"; ctx.fill();
            } else if (p.isSliding) {
                ctx.beginPath(); ctx.arc(0, 0, 35, 0, Math.PI*2);
                ctx.fillStyle = "rgba(0, 255, 255, 0.5)"; ctx.fill();
            }

            // Sprite
            let sprite;
            const isMe = (p.id === playerId);
            let isMoving = isMe ? (myInput.up || myInput.down || myInput.left || myInput.right) : (Math.abs(p.vx) > 0.5 || Math.abs(p.vy) > 0.5);
            if (p.isSliding) isMoving = true;

            if (!isMoving) {
                sprite = isMe ? imgPlayerIdle : imgEnemyIdle;
            } else {
                const frame = Math.floor(now / 150) % 2; 
                sprite = isMe ? (frame === 0 ? imgPlayerRun1 : imgPlayerRun2) : (frame === 0 ? imgEnemyRun1 : imgEnemyRun2);
            }

            if (!p.alive) ctx.globalAlpha = 0.5;
            const size = 60; 
            ctx.drawImage(sprite, -size/2, -size/2, size, size);
            ctx.restore(); 

            // Name
            ctx.fillStyle = "black";
            ctx.font = "bold 14px Arial";
            ctx.textAlign = "center";
            ctx.fillText(p.username || "Player", p.x, p.y + 40);
        });

        ctx.restore();
    }
</script>
</body>
</html>