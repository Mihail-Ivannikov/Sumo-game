<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Sumo Arena Test Client</title>
<script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
<style>
  body { font-family: Arial, sans-serif; background: #333; color: white; text-align: center; }
  #controls { margin-bottom: 10px; }
  #arena { 
      background: #eee; 
      border-radius: 50%; 
      cursor: crosshair; 
      box-shadow: 0 0 20px black;
  }
  #debug { 
      position: fixed; 
      top: 10px; 
      left: 10px; 
      background: rgba(0,0,0,0.8); 
      color: #0f0; 
      padding: 15px; 
      font-family: monospace; 
      font-size: 18px; 
      border: 1px solid #0f0;
      pointer-events: none; 
      text-align: left;
      min-width: 200px;
  }
</style>
</head>
<body>

<h2>Sumo Arena Test</h2>
<div id="controls">
  <button id="readyBtn" style="padding: 10px 20px; font-size: 16px; cursor: pointer;">Ready</button>
</div>
<div id="countdown"></div>

<canvas id="arena" width="600" height="600" tabindex="0"></canvas>
<div id="debug">Waiting for input...</div>

<!-- TYPE="MODULE" IS IMPORTANT HERE -->
<script type="module">
    import setupInput from './input.js';

    // ==== 1. Setup & Connection ====
    const socket = io("http://localhost:3000");
    let playerId;
    let roomId;

    // ==== 2. Initialize Input Module ====
    // We pass the socket so the module can emit events
    setupInput(socket);

    // ==== 3. Network Logic ====
    socket.emit("join-room");
    
    socket.on("joined-room", (data) => {
        playerId = data.playerId;
        roomId = data.roomId;
        console.log(`Joined room ${roomId} as ${playerId}`);
    });

    // UI Updates
    socket.on("countdown", num => document.getElementById("countdown").innerText = "Game starting in: " + num);
    socket.on("ready-timer", num => document.getElementById("countdown").innerText = "Ready timer: " + num);
    socket.on("room-updated", data => {
        const readyCount = data.players.filter(p => p.ready).length;
        document.getElementById("countdown").innerText = `Ready: ${readyCount}/${data.players.length}`;
    });

    // ==== 4. Rendering Logic ====
    const canvas = document.getElementById("arena");
    const ctx = canvas.getContext("2d");
    const arenaRadius = 250; 
    let gameState = { players: [] };

    socket.on("state-update", data => {
        gameState = data;
        drawArena();
    });

    function drawArena() {
        ctx.clearRect(0,0,canvas.width,canvas.height);

        ctx.save();
        ctx.translate(canvas.width/2, canvas.height/2);

        // Draw Arena
        ctx.beginPath();
        ctx.arc(0, 0, arenaRadius, 0, Math.PI*2);
        ctx.fillStyle = "#ddd";
        ctx.fill();
        ctx.lineWidth = 5;
        ctx.strokeStyle = "#444";
        ctx.stroke();

        // Draw Players
        gameState.players.forEach(p => {
            ctx.beginPath();
            ctx.arc(p.x, p.y, 25, 0, Math.PI*2);
            
            // Color based on state
            if (!p.alive) ctx.fillStyle = "#555"; // Dead
            else if (p.isInvulnerable) ctx.fillStyle = "gold";
            else if (p.isSliding) ctx.fillStyle = "cyan"; // Visual slide
            else if (p.id === playerId) ctx.fillStyle = "blue"; // Self
            else ctx.fillStyle = "red"; // Enemy

            ctx.fill();
            ctx.stroke();

            // ID Text
            ctx.fillStyle = "white";
            ctx.font = "12px Arial";
            ctx.textAlign = "center";
            ctx.fillText(p.id.slice(0,2), p.x, p.y+4);
        });

        ctx.restore();
    }
</script>
</body>
</html>